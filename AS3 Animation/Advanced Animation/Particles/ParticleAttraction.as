package {	import flash.events.Event;	import flash.display.Sprite;	import flash.display.StageScaleMode;	import flash.display.StageAlign;		[SWF (backgroundColor = 0x000000)]		public class ParticleAttraction extends Sprite {		private var particle:Ball;		private var numParticles:Number = 50;		private var particles:Array;		private var bounce:Number = -1;				public function ParticleAttraction():void {			stage.align = StageAlign.TOP_LEFT;			stage.scaleMode = StageScaleMode.NO_SCALE;			init();		}				private function init():void {			particles = new Array();						for (var i:Number = 0; i< numParticles; i++) {				particle = new Ball(8, 0xffffff);				particle.x = Math.random() * stage.stageWidth;				particle.y = Math.random() * stage.stageHeight;				particle.mass = Math.random() * 2;				addChild(particle);				particles.push(particle);			}						stage.addEventListener(Event.ENTER_FRAME, onStart);		}				private function onStart(evt:Event):void {			for (var i:Number = 0; i< numParticles; i++) {				var part:Ball = particles[i] as Ball;				part.x += part.vx;				part.y += part.vy;								checkBounds(part);			}									for (i = 0; i< numParticles - 1; i++) {				var partA:Ball = Ball(particles[i]);				for (var j:Number = i+1; j< numParticles; j++) {					var partB:Ball = Ball(particles[j]);					gravity(partA, partB);					checkCollision(partA, partB);				}			}		}				private function gravity(partA:Ball, partB:Ball):void {			var dx:Number = partB.x - partA.x;			var dy:Number = partB.y - partA.y;			var dist:Number = dx*dx + dy*dy;			var distSq:Number = Math.sqrt(dist);			var force:Number = partB.mass * partA.mass / dist;			var ax:Number = force * dx / distSq;			var ay:Number = force * dy / distSq;			partA.vx += ax / partA.mass;			partA.vy += ay / partA.mass;			partB.vx += ax / partB.mass;			partB.vy += ay / partB.mass;		}						function checkCollision (ball0:Ball, ball1:Ball):void {			var dx:Number = ball1.x - ball0.x;			var dy:Number = ball1.y - ball0.y;			var dist:Number = Math.sqrt(dx*dx + dy*dy);						if (dist < ball0.radius + ball1.radius) {				var angle:Number = Math.atan2(dy, dx);				var cos:Number = Math.cos(angle);				var sin:Number = Math.sin(angle);								var x0:Number = 0;				var y0:Number = 0;				var x1:Number = dx * cos + dy * sin;				var y1:Number = dy * cos - dx * sin;								var vx0:Number = ball0.vx * cos + ball0.vy * sin;				var vy0:Number = ball0.vy * cos - ball0.vx * sin;				var vx1:Number = ball1.vx * cos + ball1.vy * sin;				var vy1:Number = ball1.vy * cos - ball1.vx * sin;											var vxTotal:Number = vx0 - vx1;				var absV:Number = Math.abs(vx0) + Math.abs(vx1);				var overlap:Number = (ball0.radius + ball1.radius) - Math.abs(x0 - x1);				vx0 = ((ball0.mass - ball1.mass) * vx0 + 2 * ball1.mass * vx1) / (ball1.mass + ball0.mass);				vx1 = vxTotal + vx0;												x0 += vx0/absV * overlap;				x1 += vx1/absV * overlap;								var x0Final:Number = x0 * cos - y0 * sin;				var y0Final:Number = y0 * cos + x0 * sin;				var x1Final:Number = x1 * cos - y1 * sin;				var y1Final:Number = y1 * cos + x1 * sin;								ball0.x = ball0.x + x0Final;				ball0.y = ball0.y + y0Final;				ball1.x = ball0.x + x1Final;				ball1.y = ball0.y + y1Final;									ball0.vx = vx0 * cos - vy0 * sin;				ball0.vy = vy0 * cos + vx0 * sin;				ball1.vx = vx1 * cos - vy1 * sin;				ball1.vy = vy1 * cos + vx1 * sin;							}		}				function checkBounds(ball:Ball):void {			if (ball.x < ball.radius) {				ball.x = ball.radius;				ball.vx *= bounce;			}						if (ball.x > stage.stageWidth - ball.radius) {				ball.x = stage.stageWidth - ball.radius;				ball.vx *= bounce;			}						if (ball.y < ball.radius) {				ball.y = ball.radius;				ball.vy *= bounce;			}						if (ball.y > stage.stageHeight - ball.radius) {				ball.y = stage.stageHeight - ball.radius;				ball.vy *= bounce;			}		}	}}